# [NIM游戏](https://www.acwing.com/problem/content/893/)



```
给定 n 堆石子，两位玩家轮流操作，每次操作可以从任意一堆石子中拿走任意数量的石子（可以拿完，但不能不拿），最后无法进行操作的人视为失败。

问如果两人都采用最优策略，先手是否必胜。
```

NIM游戏是一个经典的博弈论模型，称之为公平组合博弈ICG，其特征是博弈由双方进行，局面在每一步中都将逐渐接近终局且步骤数有限，双方的能力和信息完全对等，且不存在随机因素

NIM游戏可以抽象成，**对于一个自然数序列，每一次可以对一个值减去一个正整数，双方交替执行，减去后的值必须也是自然数。当一方遇到全0的局面时，则宣布该方失败。给出一个局面，问此局面下是否能赢**。先给出结论：**当序列的异或和为0时，必败，否则可胜**，证明如下
$$
1. 对于全0序列，显然异或和为0 \\
2. 对于非全0序列但异或和为0，我们的任何操作都必将导致疑惑和不为0\\
3. 对于非全0序列且异或和非0，我们总有办法通过减法使其异或和变成0\\
第一点是显然的\\
第二点，把整体序列分割成被减数和其他数，显然其他数的异或和等于被减数\\
因为异或为0当且仅当两数相等，而若我们修改了被减数势必导致二者不等，则异或和必不为0\\
对于第三点，首先，要想使得异或和为0，一个可行的做法是，选一个序列中的数，把结果中比特位为1的位置翻转\\
即可完成结果为0的变换，但是这样的变换不一定是减法操作可以做到的，因此我们不能随便选一个数操作\\
而是应该选择翻转的最高位为1的数，这样，由于最高位由0变1，无论后面怎么变，数值都必定是减小的，而且这个数必定存在（显然）\\
通过以上三条规则，我们可以保证，如果初始状态异或和为非0，则我们可以永远让对手面对为0的局面，直到游戏结束，反之亦然
$$
有人可能会纠结这样的思路是如何产生的，事实上，NIM本身只是一个数学巧合，或者反过来说有人发现了上面的性质而发明了NIM游戏，其关键并不在某一种运算的强大，而是整体从获胜局面可以人为的控制转向失败局面，而失败局面又不得不转换为获胜局面，从而让对手保持状态直到游戏结束，任何满足这样的数学运算过程都可发明出一种游戏

> 不过对于异或序列的上述三条性质在博弈论中非常常用，一种天然的公平组合博弈模型

## [集合NIM游戏](https://www.acwing.com/problem/content/895/)与SG函数

```
给定 n 堆石子以及一个由 k 个不同正整数构成的数字集合 S。

现在有两位玩家轮流操作，每次操作可以从任意一堆石子中拿取石子，每次拿取的石子数量必须包含于集合 S，最后无法进行操作的人视为失败。

问如果两人都采用最优策略，先手是否必胜。
```

由此问题，我们引出ICG问题的通解，SG函数模型。要想理解 SG 函数，首先要理解博弈问题的图表示

+ 一个局面定义成图中的节点
+ 可以执行的操作定义成一条有向边

显然，上述图是一个有向无环图，我们定义没有出边的点为终点（游戏结束），则我们以下列公式定义SG函数
$$
SG(N) = 0,N是终点\\
SG(x) = mex(\{SG(y)|y是x的邻接点\}),mex函数的值是集合的补集中最小的自然数
$$
我们把 $SG(x) = n$ 的点称为 n 级胜点，对于其中一方，当其遇到非 0 胜点时，必定可以操作到 0 级胜点，而 0 级胜点却不得不转移到非 0 级胜点，因此一方可以强制另一方始终面对 0 胜点，直到游戏结束败北

SG 的威力远不止于此，SG 可以解决多组对局下的胜负问题。以上述游戏来说，每一堆石子就是一个对局，拿石子就是一个操作，石子的数量就是一个局面，每一个回合，我们可以选择操作其中一场对局，SG函数如何解决这样的问题？

我们可以把操作看作是对 SG 值得修改，例如操作一个 SG 值为 5 得局面，我们可以把操作到 SG 值为 0 到 4 的任意一种局面，即对一个局面的 SG 值做减法。每一回合，一方可以对任意一个对局做减法，直到全部的对局 SG 为 0。这看起来很眼熟，事实上，如果把局面的 SG 值看作是一串自然数序列，则问题再次抽象成了经典 NIM 游戏

当然，其与经典 NIM 游戏还略有不同，因为 SG 值实际上是可以上涨的，从定义上看， SG = 5 的局面也可以操作到 SG 为 6 的局面，但是，如果对手把局面从 5 变成了 6，则我们必然可以把 6 再次变成 5，从而等效于不变，最终对手依然需要面对问题

SG 函数的定义根据不同的题目可能产生不同的变化，但是其含义都是“在这种局面下的n级胜点”

## [拆分NIM游戏](https://www.acwing.com/problem/content/896/)

```
给定 n 堆石子，两位玩家轮流操作，每次操作可以取走其中的一堆石子，然后放入两堆规模更小的石子（新堆规模可以为 0，且两个新堆的石子总数可以大于取走的那堆石子数），最后无法进行操作的人视为失败。

问如果两人都采用最优策略，先手是否必胜。
```

以拆分NIM游戏为例，来展示SG函数定义的灵活性

虽然在集合NIM游戏中，我们给出了SG函数的完整内容，但是有没有提及的是，**如何定义一个局面？**。事实上，局面的定义并不一定要是一个数字，我们完全可以把一个序列也定义成一个局面，而 SG 函数对于序列的操作，则是拆分求值。换句话说，SG函数可以定义为，**当参数为值时，根据具体定义求解；当参数为序列时，拆分序列对各个值分别求解并以异或合并**

本题中，一堆石子操作后，会变成两堆小一点的石子，这可以等价于对一个数操作后，变成一个长度为2的序列，这正是与集合NIM游戏的本质不同，一个是值变成值，一个是值变成序列，那么根据对SG函数的定义，自然也就不难得到本题SG函数的定义了
$$
SG(0) = 0\\
SG(x) = mex(\vec{v}),\vec{v} \in \{(y_1,y_2) | y_1\lt x\and\ y_2\lt x\} \\
SG(\vec{x}) = SG(x_1)\bigoplus SG(x_2)\bigoplus ....\bigoplus SG(x_n)
$$
